
1. 引言
   1.1 编写目的
       本文档旨在详细阐述“弹指足球”游戏软件的总体设计、模块划分、核心算法及接口设计，为开发实现、测试维护及软件著作权申请提供技术依据。

   1.2 适用范围
       本说明书适用于微信小游戏、抖音小游戏及Web端H5版本的开发与维护。

2. 总体设计
   2.1 开发环境
       - 编程语言：JavaScript (ES6+)
       - 渲染引擎：Pixi.js (v6.5)
       - 物理引擎：Matter.js (v0.18+)
       - 打包工具：Vite
       - 后端服务：Cloudflare Workers + Durable Objects (WebSocket) + D1 Database

   2.2 架构设计
       软件采用 MVC (Model-View-Controller) 变种架构：
       - View (UI层)：基于 Pixi.js 的场景管理（SceneManager）和 UI 组件（GameHUD, Button, GoalBanner, AIChatBubble）。
       - Controller (逻辑层)：InputController 处理用户输入，TurnManager 管理回合流程，AIController 处理人机逻辑，OnlineMatchController 处理网络同步。
       - Model (数据/物理层)：PhysicsEngine 封装 Matter.js 物理世界，AccountMgr 管理用户数据，GameRules 处理得分判定。

3. 模块设计
   3.1 场景管理模块 (SceneManager)
       - 负责场景的切换、销毁与生命周期管理。
       - 包含场景：LoginScene（登录）、MenuScene（主菜单）、LobbyScene（大厅/房间列表）、RoomScene（备战室）、GameScene（核心对战）、ResultScene（结算）、LevelSelectScene（关卡选择）。
       - 适配策略：宽屏锁定高度，窄屏锁定宽度。

   3.2 物理引擎模块 (PhysicsEngine)
       - 封装 Matter.js，配置重力为0（俯视视角）。
       - 实现了 StoppingFriction 自定义摩擦力模型，解决低速无限滑行问题。
       - 定义了 CollisionCategory：Wall, Striker, Ball, Goal, GoalNet。
       - 实现了基于物理帧插值的视觉平滑算法。

   3.3 网络通信模块 (NetworkMgr)
       - 支持 HTTP (POST/GET) 请求处理登录、数据同步及房间列表获取。
       - 基于 WebSocket 实现全双工通信，用于实时对战。
       - 实现了心跳检测、断线重连、状态快照恢复。
       - 消息协议：JOIN, READY, START, MOVE, TRAJECTORY_BATCH, GOAL, LEAVE 等。

   3.4 AI 决策与交互模块 (AIController & AIChat)
       - 决策逻辑：基于评分系统的行为树（常规射门、反弹射门、暴力破局、解围、防守）。
       - 交互系统：配置了5种人格（Hot, Troll, Robot, Noble, Cute）。
       - 触发器：监听游戏事件（进球、乌龙、超时、撞柱等），根据概率和冷却时间触发气泡对话。

4. 核心算法与逻辑
   4.1 物理同步算法
       - 采用“状态同步 + 客户端预测 + 轨迹回放”模型。
       - 发送端：以 100ms 为间隔打包物理刚体轨迹数据。
       - 接收端：维护缓冲队列，收到 GOAL 消息时会等待队列播放完毕再执行进球逻辑，确保动画连贯。

   4.2 碰撞与进球检测
       - 进球判定：检测 Ball 与 GoalSensor 的碰撞事件。
       - 进球后触发 GoalBanner 动画，并锁定物理状态防止二次触发，2秒后重置阵型。
       - 乌龙球判定：通过对比回合方（TurnId）与得分方（ScoreTeam）判断。

   4.3 防作弊与边界处理
       - 公平竞赛检测：回合结束时，若棋子停留在己方球门内，触发 Reposition 动画将其移出。
       - 强制边界约束：防止高速物体穿透墙壁。

5. 接口设计
   5.1 服务端接口 (Cloudflare Workers)
       - POST /api/login/minigame: 小程序登录。
       - GET  /api/rooms/list: 获取当前等待中的房间列表（包含房主信息）。
       - POST /api/room/check: 检查指定房间状态。
       - WS   /api/room/{roomId}/websocket: 建立游戏长连接。
       - POST /api/match/record: 上报比赛结果与统计数据。

   5.2 存储设计 (SQLite / D1)
       - users 表: 存储 user_id, nickname, coins, level, items, theme, unlocked_themes, match_stats。
       - room_records 表: 存储房间状态、房主信息，用于大厅列表展示。
       - match_history 表: 存储近期对战记录。

6. 资源管理
   - 使用 ResourceManager 单例管理。
   - 支持动态主题加载：根据配置 ID 加载对应的棋子、球场和足球纹理。
   - 广告资源预埋：配置了微信/抖音平台的 Banner、激励视频、插屏广告 ID。
